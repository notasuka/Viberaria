name: Build Viberaria tMod

env:
  TML_BUILD_PATH_OVERRIDE: ./bin
  GH_TOKEN: ${{ github.token }}
  
on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
    
permissions: 
  contents: write
  pull-requests: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        

      - name: Auto-bump patch version in build.txt
        shell: powershell
        run: |
          $buildTxt = "src/Viberaria/build.txt"
          $lines = Get-Content $buildTxt
          $updatedLines = @()
          $newVersion = $null

          foreach ($line in $lines) {
              if ($line -match '^version *= *(\d+)\.(\d+)\.(\d+)$') {
                  $major = [int]$matches[1]
                  $minor = [int]$matches[2]
                  $patch = [int]$matches[3] + 1
                  $newVersion = "$major.$minor.$patch"
                  $updatedLines += "version = $newVersion"
                  echo "VERSION=$newVersion" | Out-File -FilePath $env:GITHUB_ENV -Append
              } else {
                  $updatedLines += $line
              }
          }

          $updatedLines | Set-Content $buildTxt

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create bump branch
          $branch = "version-bump-$newVersion"
          git checkout -b $branch
          git add $buildTxt
          git commit -m "CI: bump version to $newVersion"

          # Tag locally
          if (-not (git tag --list "v$newVersion")) {
              git tag "v$newVersion"
          }

          # Push branch and tag (NOT master)
          git push -u origin $branch --tags

          # Create PR
          gh pr create `
            --title "Version bump to $newVersion" `
            --body "Automated version bump" `
            --base master `
            --head $branch

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Download tModLoader
        run: |
          curl -s -L https://github.com/tModLoader/tModLoader/releases/latest/download/tModLoader.zip -o tModLoader.zip

      - name: Extract tModLoader
        run: |
          unzip -q -o tModLoader.zip -d ../tModLoader
          rm tModLoader.zip
          
      - name: Create tModLoader.targets file
        shell: bash
        run: |
          cat >> ../tModLoader.targets << EOF
          <Project ToolsVersion="14.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
            <Import Project="tModLoader\tMLMod.targets" />
          </Project>
          EOF

      - name: Restore Dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build Viberaria.sln --configuration Release
        
      - name: Set version output
        id: version
        run: echo "version=${{ env.VERSION }}" >> $GITHUB_OUTPUT

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artifacts
          path: |
            ./bin/tModLoader/Mods/Viberaria.tmod

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'

    steps:
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: artifacts
          path: release-artifact

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.build.outputs.version }}
          name: Release v${{ needs.build.outputs.version }}
          files: release-artifact/*.tmod
